import{n as Ue,b as j,o as Ut,L as et,p as zt,q as Xt,r as jt,R as pt,s as ft,t as Ne,u as $e,v as _t,a as $,w as Pe,E as Wt,x as B,G as J,y as dt,z as Ve,J as qe,O as Ht,P as bt,h as ge,K as X,Q as Nt,D as Tt,X as $t,M as G,Y as qt,Z as Kt,_ as Yt,g as Zt,B as Ke,F as he,$ as Qt,a0 as Jt,V as en,a1 as tn,a2 as Q,a3 as nn,a4 as ae,a5 as rn,a6 as ht,a7 as on,d as an,a8 as sn,e as cn,f as ln,a9 as un,i as N,aa as ie,j as we,ab as pn,ac as fn,ad as rt,ae as dn,af as mt,ag as hn,C as mn,ah as gn}from"./three.module-BZTDV-n9.js";import{O as wn}from"./OrbitControls-C2c80Z-8.js";/*!
fflate - fast JavaScript compression/decompression
<https://101arrowz.github.io/fflate>
Licensed under MIT. https://github.com/101arrowz/fflate/blob/master/LICENSE
version 0.6.9
*/var gt=function(c){return URL.createObjectURL(new Blob([c],{type:"text/javascript"}))};try{URL.revokeObjectURL(gt(""))}catch{gt=function(e){return"data:application/javascript;charset=UTF-8,"+encodeURI(e)}}var q=Uint8Array,ce=Uint16Array,tt=Uint32Array,St=new q([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),kt=new q([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),vn=new q([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ct=function(c,e){for(var t=new ce(31),n=0;n<31;++n)t[n]=e+=1<<c[n-1];for(var o=new tt(t[30]),n=1;n<30;++n)for(var r=t[n];r<t[n+1];++r)o[r]=r-t[n]<<5|n;return[t,o]},Pt=Ct(St,2),Ft=Pt[0],xn=Pt[1];Ft[28]=258,xn[258]=28;var yn=Ct(kt,0),bn=yn[0],nt=new ce(32768);for(var M=0;M<32768;++M){var se=(M&43690)>>>1|(M&21845)<<1;se=(se&52428)>>>2|(se&13107)<<2,se=(se&61680)>>>4|(se&3855)<<4,nt[M]=((se&65280)>>>8|(se&255)<<8)>>>1}var Fe=function(c,e,t){for(var n=c.length,o=0,r=new ce(e);o<n;++o)++r[c[o]-1];var a=new ce(e);for(o=0;o<e;++o)a[o]=a[o-1]+r[o-1]<<1;var s;if(t){s=new ce(1<<e);var i=15-e;for(o=0;o<n;++o)if(c[o])for(var u=o<<4|c[o],l=e-c[o],p=a[c[o]-1]++<<l,f=p|(1<<l)-1;p<=f;++p)s[nt[p]>>>i]=u}else for(s=new ce(n),o=0;o<n;++o)c[o]&&(s[o]=nt[a[c[o]-1]++]>>>15-c[o]);return s},Ae=new q(288);for(var M=0;M<144;++M)Ae[M]=8;for(var M=144;M<256;++M)Ae[M]=9;for(var M=256;M<280;++M)Ae[M]=7;for(var M=280;M<288;++M)Ae[M]=8;var At=new q(32);for(var M=0;M<32;++M)At[M]=5;var Tn=Fe(Ae,9,1),Sn=Fe(At,5,1),Ye=function(c){for(var e=c[0],t=1;t<c.length;++t)c[t]>e&&(e=c[t]);return e},Y=function(c,e,t){var n=e/8|0;return(c[n]|c[n+1]<<8)>>(e&7)&t},Ze=function(c,e){var t=e/8|0;return(c[t]|c[t+1]<<8|c[t+2]<<16)>>(e&7)},kn=function(c){return(c/8|0)+(c&7&&1)},Cn=function(c,e,t){(t==null||t>c.length)&&(t=c.length);var n=new(c instanceof ce?ce:c instanceof tt?tt:q)(t-e);return n.set(c.subarray(e,t)),n},Pn=function(c,e,t){var n=c.length;if(!n||t&&!t.l&&n<5)return e||new q(0);var o=!e||t,r=!t||t.i;t||(t={}),e||(e=new q(n*3));var a=function(ne){var xe=e.length;if(ne>xe){var k=new q(Math.max(xe*2,ne));k.set(e),e=k}},s=t.f||0,i=t.p||0,u=t.b||0,l=t.l,p=t.d,f=t.m,h=t.n,m=n*8;do{if(!l){t.f=s=Y(c,i,1);var x=Y(c,i+1,3);if(i+=3,x)if(x==1)l=Tn,p=Sn,f=9,h=5;else if(x==2){var y=Y(c,i,31)+257,A=Y(c,i+10,15)+4,V=y+Y(c,i+5,31)+1;i+=14;for(var R=new q(V),E=new q(19),w=0;w<A;++w)E[vn[w]]=Y(c,i+w*3,7);i+=A*3;for(var I=Ye(E),F=(1<<I)-1,_=Fe(E,I,1),w=0;w<V;){var W=_[Y(c,i,F)];i+=W&15;var v=W>>>4;if(v<16)R[w++]=v;else{var K=0,H=0;for(v==16?(H=3+Y(c,i,3),i+=2,K=R[w-1]):v==17?(H=3+Y(c,i,7),i+=3):v==18&&(H=11+Y(c,i,127),i+=7);H--;)R[w++]=K}}var pe=R.subarray(0,y),U=R.subarray(y);f=Ye(pe),h=Ye(U),l=Fe(pe,f,1),p=Fe(U,h,1)}else throw"invalid block type";else{var v=kn(i)+4,C=c[v-4]|c[v-3]<<8,T=v+C;if(T>n){if(r)throw"unexpected EOF";break}o&&a(u+C),e.set(c.subarray(v,T),u),t.b=u+=C,t.p=i=T*8;continue}if(i>m){if(r)throw"unexpected EOF";break}}o&&a(u+131072);for(var Ie=(1<<f)-1,Re=(1<<h)-1,ee=i;;ee=i){var K=l[Ze(c,i)&Ie],te=K>>>4;if(i+=K&15,i>m){if(r)throw"unexpected EOF";break}if(!K)throw"invalid length/literal";if(te<256)e[u++]=te;else if(te==256){ee=i,l=null;break}else{var Le=te-254;if(te>264){var w=te-257,le=St[w];Le=Y(c,i,(1<<le)-1)+Ft[w],i+=le}var ve=p[Ze(c,i)&Re],ue=ve>>>4;if(!ve)throw"invalid distance";i+=ve&15;var U=bn[ue];if(ue>3){var le=kt[ue];U+=Ze(c,i)&(1<<le)-1,i+=le}if(i>m){if(r)throw"unexpected EOF";break}o&&a(u+131072);for(var fe=u+Le;u<fe;u+=4)e[u]=e[u-U],e[u+1]=e[u+1-U],e[u+2]=e[u+2-U],e[u+3]=e[u+3-U];u=fe}}t.l=l,t.p=ee,t.b=u,l&&(s=1,t.m=f,t.d=p,t.n=h)}while(!s);return u==e.length?e:Cn(e,0,u)},Fn=new q(0),An=function(c){if((c[0]&15)!=8||c[0]>>>4>7||(c[0]<<8|c[1])%31)throw"invalid zlib data";if(c[1]&32)throw"invalid zlib data: preset dictionaries not supported"};function In(c,e){return Pn((An(c),c.subarray(2,-4)),e)}var Rn=typeof TextDecoder<"u"&&new TextDecoder,Ln=0;try{Rn.decode(Fn,{stream:!0}),Ln=1}catch{}function It(c,e,t){const n=t.length-c-1;if(e>=t[n])return n-1;if(e<=t[c])return c;let o=c,r=n,a=Math.floor((o+r)/2);for(;e<t[a]||e>=t[a+1];)e<t[a]?r=a:o=a,a=Math.floor((o+r)/2);return a}function En(c,e,t,n){const o=[],r=[],a=[];o[0]=1;for(let s=1;s<=t;++s){r[s]=e-n[c+1-s],a[s]=n[c+s]-e;let i=0;for(let u=0;u<s;++u){const l=a[u+1],p=r[s-u],f=o[u]/(l+p);o[u]=i+l*f,i=p*f}o[s]=i}return o}function Mn(c,e,t,n){const o=It(c,n,e),r=En(o,n,c,e),a=new Ue(0,0,0,0);for(let s=0;s<=c;++s){const i=t[o-c+s],u=r[s],l=i.w*u;a.x+=i.x*l,a.y+=i.y*l,a.z+=i.z*l,a.w+=i.w*u}return a}function Dn(c,e,t,n,o){const r=[];for(let p=0;p<=t;++p)r[p]=0;const a=[];for(let p=0;p<=n;++p)a[p]=r.slice(0);const s=[];for(let p=0;p<=t;++p)s[p]=r.slice(0);s[0][0]=1;const i=r.slice(0),u=r.slice(0);for(let p=1;p<=t;++p){i[p]=e-o[c+1-p],u[p]=o[c+p]-e;let f=0;for(let h=0;h<p;++h){const m=u[h+1],x=i[p-h];s[p][h]=m+x;const v=s[h][p-1]/s[p][h];s[h][p]=f+m*v,f=x*v}s[p][p]=f}for(let p=0;p<=t;++p)a[0][p]=s[p][t];for(let p=0;p<=t;++p){let f=0,h=1;const m=[];for(let x=0;x<=t;++x)m[x]=r.slice(0);m[0][0]=1;for(let x=1;x<=n;++x){let v=0;const C=p-x,T=t-x;p>=x&&(m[h][0]=m[f][0]/s[T+1][C],v=m[h][0]*s[C][T]);const y=C>=-1?1:-C,A=p-1<=T?x-1:t-p;for(let R=y;R<=A;++R)m[h][R]=(m[f][R]-m[f][R-1])/s[T+1][C+R],v+=m[h][R]*s[C+R][T];p<=T&&(m[h][x]=-m[f][x-1]/s[T+1][p],v+=m[h][x]*s[p][T]),a[x][p]=v;const V=f;f=h,h=V}}let l=t;for(let p=1;p<=n;++p){for(let f=0;f<=t;++f)a[p][f]*=l;l*=t-p}return a}function Bn(c,e,t,n,o){const r=o<c?o:c,a=[],s=It(c,n,e),i=Dn(s,n,c,r,e),u=[];for(let l=0;l<t.length;++l){const p=t[l].clone(),f=p.w;p.x*=f,p.y*=f,p.z*=f,u[l]=p}for(let l=0;l<=r;++l){const p=u[s-c].clone().multiplyScalar(i[l][0]);for(let f=1;f<=c;++f)p.add(u[s-c+f].clone().multiplyScalar(i[l][f]));a[l]=p}for(let l=r+1;l<=o+1;++l)a[l]=new Ue(0,0,0);return a}function On(c,e){let t=1;for(let o=2;o<=c;++o)t*=o;let n=1;for(let o=2;o<=e;++o)n*=o;for(let o=2;o<=c-e;++o)n*=o;return t/n}function Gn(c){const e=c.length,t=[],n=[];for(let r=0;r<e;++r){const a=c[r];t[r]=new j(a.x,a.y,a.z),n[r]=a.w}const o=[];for(let r=0;r<e;++r){const a=t[r].clone();for(let s=1;s<=r;++s)a.sub(o[r-s].clone().multiplyScalar(On(r,s)*n[s]));o[r]=a.divideScalar(n[0])}return o}function Vn(c,e,t,n,o){const r=Bn(c,e,t,n,o);return Gn(r)}class Un extends Ut{constructor(e,t,n,o,r){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=o||0,this.endKnot=r||this.knots.length-1;for(let a=0;a<n.length;++a){const s=n[a];this.controlPoints[a]=new Ue(s.x,s.y,s.z,s.w)}}getPoint(e,t=new j){const n=t,o=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),r=Mn(this.degree,this.knots,this.controlPoints,o);return r.w!==1&&r.divideScalar(r.w),n.set(r.x,r.y,r.z)}getTangent(e,t=new j){const n=t,o=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),r=Vn(this.degree,this.knots,this.controlPoints,o,1);return n.copy(r[1]).normalize(),n}}let S,O,z;class zn extends et{constructor(e){super(e)}load(e,t,n,o){const r=this,a=r.path===""?zt.extractUrlBase(e):r.path,s=new Xt(this.manager);s.setPath(r.path),s.setResponseType("arraybuffer"),s.setRequestHeader(r.requestHeader),s.setWithCredentials(r.withCredentials),s.load(e,function(i){try{t(r.parse(i,a))}catch(u){o?o(u):console.error(u),r.manager.itemError(e)}},n,o)}parse(e,t){if(Nn(e))S=new Hn().parse(e);else{const o=Mt(e);if(!$n(o))throw new Error("THREE.FBXLoader: Unknown format.");if(vt(o)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+vt(o));S=new Wn().parse(o)}const n=new jt(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new Xn(n,this.manager).parse(S)}}class Xn{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){O=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),n=this.parseMaterials(t),o=this.parseDeformers(),r=new jn().parse(o);return this.parseScene(o,r,n),z}parseConnections(){const e=new Map;return"Connections"in S&&S.Connections.connections.forEach(function(n){const o=n[0],r=n[1],a=n[2];e.has(o)||e.set(o,{parents:[],children:[]});const s={ID:r,relationship:a};e.get(o).parents.push(s),e.has(r)||e.set(r,{parents:[],children:[]});const i={ID:o,relationship:a};e.get(r).children.push(i)}),e}parseImages(){const e={},t={};if("Video"in S.Objects){const n=S.Objects.Video;for(const o in n){const r=n[o],a=parseInt(o);if(e[a]=r.RelativeFilename||r.Filename,"Content"in r){const s=r.Content instanceof ArrayBuffer&&r.Content.byteLength>0,i=typeof r.Content=="string"&&r.Content!=="";if(s||i){const u=this.parseImage(n[o]);t[r.RelativeFilename||r.Filename]=u}}}}for(const n in e){const o=e[n];t[o]!==void 0?e[n]=t[o]:e[n]=e[n].split("\\").pop()}return e}parseImage(e){const t=e.Content,n=e.RelativeFilename||e.Filename,o=n.slice(n.lastIndexOf(".")+1).toLowerCase();let r;switch(o){case"bmp":r="image/bmp";break;case"jpg":case"jpeg":r="image/jpeg";break;case"png":r="image/png";break;case"tif":r="image/tiff";break;case"tga":this.manager.getHandler(".tga")===null&&console.warn("FBXLoader: TGA loader not found, skipping ",n),r="image/tga";break;default:console.warn('FBXLoader: Image type "'+o+'" is not supported.');return}if(typeof t=="string")return"data:"+r+";base64,"+t;{const a=new Uint8Array(t);return window.URL.createObjectURL(new Blob([a],{type:r}))}}parseTextures(e){const t=new Map;if("Texture"in S.Objects){const n=S.Objects.Texture;for(const o in n){const r=this.parseTexture(n[o],e);t.set(parseInt(o),r)}}return t}parseTexture(e,t){const n=this.loadTexture(e,t);n.ID=e.id,n.name=e.attrName;const o=e.WrapModeU,r=e.WrapModeV,a=o!==void 0?o.value:0,s=r!==void 0?r.value:0;if(n.wrapS=a===0?pt:ft,n.wrapT=s===0?pt:ft,"Scaling"in e){const i=e.Scaling.value;n.repeat.x=i[0],n.repeat.y=i[1]}if("Translation"in e){const i=e.Translation.value;n.offset.x=i[0],n.offset.y=i[1]}return n}loadTexture(e,t){let n;const o=this.textureLoader.path,r=O.get(e.id).children;r!==void 0&&r.length>0&&t[r[0].ID]!==void 0&&(n=t[r[0].ID],(n.indexOf("blob:")===0||n.indexOf("data:")===0)&&this.textureLoader.setPath(void 0));let a;const s=e.FileName.slice(-3).toLowerCase();if(s==="tga"){const i=this.manager.getHandler(".tga");i===null?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),a=new Ne):(i.setPath(this.textureLoader.path),a=i.load(n))}else if(s==="dds"){const i=this.manager.getHandler(".dds");i===null?(console.warn("FBXLoader: DDS loader not found, creating placeholder texture for",e.RelativeFilename),a=new Ne):(i.setPath(this.textureLoader.path),a=i.load(n))}else s==="psd"?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),a=new Ne):a=this.textureLoader.load(n);return this.textureLoader.setPath(o),a}parseMaterials(e){const t=new Map;if("Material"in S.Objects){const n=S.Objects.Material;for(const o in n){const r=this.parseMaterial(n[o],e);r!==null&&t.set(parseInt(o),r)}}return t}parseMaterial(e,t){const n=e.id,o=e.attrName;let r=e.ShadingModel;if(typeof r=="object"&&(r=r.value),!O.has(n))return null;const a=this.parseParameters(e,t,n);let s;switch(r.toLowerCase()){case"phong":s=new $e;break;case"lambert":s=new _t;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',r),s=new $e;break}return s.setValues(a),s.name=o,s}parseParameters(e,t,n){const o={};e.BumpFactor&&(o.bumpScale=e.BumpFactor.value),e.Diffuse?o.color=new $().fromArray(e.Diffuse.value).convertSRGBToLinear():e.DiffuseColor&&(e.DiffuseColor.type==="Color"||e.DiffuseColor.type==="ColorRGB")&&(o.color=new $().fromArray(e.DiffuseColor.value).convertSRGBToLinear()),e.DisplacementFactor&&(o.displacementScale=e.DisplacementFactor.value),e.Emissive?o.emissive=new $().fromArray(e.Emissive.value).convertSRGBToLinear():e.EmissiveColor&&(e.EmissiveColor.type==="Color"||e.EmissiveColor.type==="ColorRGB")&&(o.emissive=new $().fromArray(e.EmissiveColor.value).convertSRGBToLinear()),e.EmissiveFactor&&(o.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(o.opacity=parseFloat(e.Opacity.value)),o.opacity<1&&(o.transparent=!0),e.ReflectionFactor&&(o.reflectivity=e.ReflectionFactor.value),e.Shininess&&(o.shininess=e.Shininess.value),e.Specular?o.specular=new $().fromArray(e.Specular.value).convertSRGBToLinear():e.SpecularColor&&e.SpecularColor.type==="Color"&&(o.specular=new $().fromArray(e.SpecularColor.value).convertSRGBToLinear());const r=this;return O.get(n).children.forEach(function(a){const s=a.relationship;switch(s){case"Bump":o.bumpMap=r.getTexture(t,a.ID);break;case"Maya|TEX_ao_map":o.aoMap=r.getTexture(t,a.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":o.map=r.getTexture(t,a.ID),o.map!==void 0&&(o.map.colorSpace=Pe);break;case"DisplacementColor":o.displacementMap=r.getTexture(t,a.ID);break;case"EmissiveColor":o.emissiveMap=r.getTexture(t,a.ID),o.emissiveMap!==void 0&&(o.emissiveMap.colorSpace=Pe);break;case"NormalMap":case"Maya|TEX_normal_map":o.normalMap=r.getTexture(t,a.ID);break;case"ReflectionColor":o.envMap=r.getTexture(t,a.ID),o.envMap!==void 0&&(o.envMap.mapping=Wt,o.envMap.colorSpace=Pe);break;case"SpecularColor":o.specularMap=r.getTexture(t,a.ID),o.specularMap!==void 0&&(o.specularMap.colorSpace=Pe);break;case"TransparentColor":case"TransparencyFactor":o.alphaMap=r.getTexture(t,a.ID),o.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",s);break}}),o}getTexture(e,t){return"LayeredTexture"in S.Objects&&t in S.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=O.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in S.Objects){const n=S.Objects.Deformer;for(const o in n){const r=n[o],a=O.get(parseInt(o));if(r.attrType==="Skin"){const s=this.parseSkeleton(a,n);s.ID=o,a.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),s.geometryID=a.parents[0].ID,e[o]=s}else if(r.attrType==="BlendShape"){const s={id:o};s.rawTargets=this.parseMorphTargets(a,n),s.id=o,a.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[o]=s}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const n=[];return e.children.forEach(function(o){const r=t[o.ID];if(r.attrType!=="Cluster")return;const a={ID:o.ID,indices:[],weights:[],transformLink:new B().fromArray(r.TransformLink.a)};"Indexes"in r&&(a.indices=r.Indexes.a,a.weights=r.Weights.a),n.push(a)}),{rawBones:n,bones:[]}}parseMorphTargets(e,t){const n=[];for(let o=0;o<e.children.length;o++){const r=e.children[o],a=t[r.ID],s={name:a.attrName,initialWeight:a.DeformPercent,id:a.id,fullWeights:a.FullWeights.a};if(a.attrType!=="BlendShapeChannel")return;s.geoID=O.get(parseInt(r.ID)).children.filter(function(i){return i.relationship===void 0})[0].ID,n.push(s)}return n}parseScene(e,t,n){z=new J;const o=this.parseModels(e.skeletons,t,n),r=S.Objects.Model,a=this;o.forEach(function(i){const u=r[i.ID];a.setLookAtProperties(i,u),O.get(i.ID).parents.forEach(function(p){const f=o.get(p.ID);f!==void 0&&f.add(i)}),i.parent===null&&z.add(i)}),this.bindSkeleton(e.skeletons,t,o),this.addGlobalSceneSettings(),z.traverse(function(i){if(i.userData.transformData){i.parent&&(i.userData.transformData.parentMatrix=i.parent.matrix,i.userData.transformData.parentMatrixWorld=i.parent.matrixWorld);const u=Lt(i.userData.transformData);i.applyMatrix4(u),i.updateWorldMatrix()}});const s=new _n().parse();z.children.length===1&&z.children[0].isGroup&&(z.children[0].animations=s,z=z.children[0]),z.animations=s}parseModels(e,t,n){const o=new Map,r=S.Objects.Model;for(const a in r){const s=parseInt(a),i=r[a],u=O.get(s);let l=this.buildSkeleton(u,e,s,i.attrName);if(!l){switch(i.attrType){case"Camera":l=this.createCamera(u);break;case"Light":l=this.createLight(u);break;case"Mesh":l=this.createMesh(u,t,n);break;case"NurbsCurve":l=this.createCurve(u,t);break;case"LimbNode":case"Root":l=new dt;break;case"Null":default:l=new J;break}l.name=i.attrName?Ve.sanitizeNodeName(i.attrName):"",l.userData.originalName=i.attrName,l.ID=s}this.getTransformData(l,i),o.set(s,l)}return o}buildSkeleton(e,t,n,o){let r=null;return e.parents.forEach(function(a){for(const s in t){const i=t[s];i.rawBones.forEach(function(u,l){if(u.ID===a.ID){const p=r;r=new dt,r.matrixWorld.copy(u.transformLink),r.name=o?Ve.sanitizeNodeName(o):"",r.userData.originalName=o,r.ID=n,i.bones[l]=r,p!==null&&r.add(p)}})}}),r}createCamera(e){let t,n;if(e.children.forEach(function(o){const r=S.Objects.NodeAttribute[o.ID];r!==void 0&&(n=r)}),n===void 0)t=new qe;else{let o=0;n.CameraProjectionType!==void 0&&n.CameraProjectionType.value===1&&(o=1);let r=1;n.NearPlane!==void 0&&(r=n.NearPlane.value/1e3);let a=1e3;n.FarPlane!==void 0&&(a=n.FarPlane.value/1e3);let s=window.innerWidth,i=window.innerHeight;n.AspectWidth!==void 0&&n.AspectHeight!==void 0&&(s=n.AspectWidth.value,i=n.AspectHeight.value);const u=s/i;let l=45;n.FieldOfView!==void 0&&(l=n.FieldOfView.value);const p=n.FocalLength?n.FocalLength.value:null;switch(o){case 0:t=new bt(l,u,r,a),p!==null&&t.setFocalLength(p);break;case 1:t=new Ht(-s/2,s/2,i/2,-i/2,r,a);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+o+"."),t=new qe;break}}return t}createLight(e){let t,n;if(e.children.forEach(function(o){const r=S.Objects.NodeAttribute[o.ID];r!==void 0&&(n=r)}),n===void 0)t=new qe;else{let o;n.LightType===void 0?o=0:o=n.LightType.value;let r=16777215;n.Color!==void 0&&(r=new $().fromArray(n.Color.value).convertSRGBToLinear());let a=n.Intensity===void 0?1:n.Intensity.value/100;n.CastLightOnObject!==void 0&&n.CastLightOnObject.value===0&&(a=0);let s=0;n.FarAttenuationEnd!==void 0&&(n.EnableFarAttenuation!==void 0&&n.EnableFarAttenuation.value===0?s=0:s=n.FarAttenuationEnd.value);const i=1;switch(o){case 0:t=new ge(r,a,s,i);break;case 1:t=new Tt(r,a);break;case 2:let u=Math.PI/3;n.InnerAngle!==void 0&&(u=X.degToRad(n.InnerAngle.value));let l=0;n.OuterAngle!==void 0&&(l=X.degToRad(n.OuterAngle.value),l=Math.max(l,1)),t=new Nt(r,a,s,u,l,i);break;default:console.warn("THREE.FBXLoader: Unknown light type "+n.LightType.value+", defaulting to a PointLight."),t=new ge(r,a);break}n.CastShadows!==void 0&&n.CastShadows.value===1&&(t.castShadow=!0)}return t}createMesh(e,t,n){let o,r=null,a=null;const s=[];return e.children.forEach(function(i){t.has(i.ID)&&(r=t.get(i.ID)),n.has(i.ID)&&s.push(n.get(i.ID))}),s.length>1?a=s:s.length>0?a=s[0]:(a=new $e({name:et.DEFAULT_MATERIAL_NAME,color:13421772}),s.push(a)),"color"in r.attributes&&s.forEach(function(i){i.vertexColors=!0}),r.FBX_Deformer?(o=new $t(r,a),o.normalizeSkinWeights()):o=new G(r,a),o}createCurve(e,t){const n=e.children.reduce(function(r,a){return t.has(a.ID)&&(r=t.get(a.ID)),r},null),o=new qt({name:et.DEFAULT_MATERIAL_NAME,color:3342591,linewidth:1});return new Kt(n,o)}getTransformData(e,t){const n={};"InheritType"in t&&(n.inheritType=parseInt(t.InheritType.value)),"RotationOrder"in t?n.eulerOrder=Et(t.RotationOrder.value):n.eulerOrder="ZYX","Lcl_Translation"in t&&(n.translation=t.Lcl_Translation.value),"PreRotation"in t&&(n.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(n.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(n.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(n.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(n.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(n.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(n.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(n.rotationPivot=t.RotationPivot.value),e.userData.transformData=n}setLookAtProperties(e,t){"LookAtProperty"in t&&O.get(e.ID).children.forEach(function(o){if(o.relationship==="LookAtProperty"){const r=S.Objects.Model[o.ID];if("Lcl_Translation"in r){const a=r.Lcl_Translation.value;e.target!==void 0?(e.target.position.fromArray(a),z.add(e.target)):e.lookAt(new j().fromArray(a))}}})}bindSkeleton(e,t,n){const o=this.parsePoseNodes();for(const r in e){const a=e[r];O.get(parseInt(a.ID)).parents.forEach(function(i){if(t.has(i.ID)){const u=i.ID;O.get(u).parents.forEach(function(p){n.has(p.ID)&&n.get(p.ID).bind(new Yt(a.bones),o[p.ID])})}})}}parsePoseNodes(){const e={};if("Pose"in S.Objects){const t=S.Objects.Pose;for(const n in t)if(t[n].attrType==="BindPose"&&t[n].NbPoseNodes>0){const o=t[n].PoseNode;Array.isArray(o)?o.forEach(function(r){e[r.Node]=new B().fromArray(r.Matrix.a)}):e[o.Node]=new B().fromArray(o.Matrix.a)}}return e}addGlobalSceneSettings(){if("GlobalSettings"in S){if("AmbientColor"in S.GlobalSettings){const e=S.GlobalSettings.AmbientColor.value,t=e[0],n=e[1],o=e[2];if(t!==0||n!==0||o!==0){const r=new $(t,n,o).convertSRGBToLinear();z.add(new Zt(r,1))}}"UnitScaleFactor"in S.GlobalSettings&&(z.userData.unitScaleFactor=S.GlobalSettings.UnitScaleFactor.value)}}}class jn{constructor(){this.negativeMaterialIndices=!1}parse(e){const t=new Map;if("Geometry"in S.Objects){const n=S.Objects.Geometry;for(const o in n){const r=O.get(parseInt(o)),a=this.parseGeometry(r,n[o],e);t.set(parseInt(o),a)}}return this.negativeMaterialIndices===!0&&console.warn("THREE.FBXLoader: The FBX file contains invalid (negative) material indices. The asset might not render as expected."),t}parseGeometry(e,t,n){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,n);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,n){const o=n.skeletons,r=[],a=e.parents.map(function(p){return S.Objects.Model[p.ID]});if(a.length===0)return;const s=e.children.reduce(function(p,f){return o[f.ID]!==void 0&&(p=o[f.ID]),p},null);e.children.forEach(function(p){n.morphTargets[p.ID]!==void 0&&r.push(n.morphTargets[p.ID])});const i=a[0],u={};"RotationOrder"in i&&(u.eulerOrder=Et(i.RotationOrder.value)),"InheritType"in i&&(u.inheritType=parseInt(i.InheritType.value)),"GeometricTranslation"in i&&(u.translation=i.GeometricTranslation.value),"GeometricRotation"in i&&(u.rotation=i.GeometricRotation.value),"GeometricScaling"in i&&(u.scale=i.GeometricScaling.value);const l=Lt(u);return this.genGeometry(t,s,r,l)}genGeometry(e,t,n,o){const r=new Ke;e.attrName&&(r.name=e.attrName);const a=this.parseGeoNode(e,t),s=this.genBuffers(a),i=new he(s.vertex,3);if(i.applyMatrix4(o),r.setAttribute("position",i),s.colors.length>0&&r.setAttribute("color",new he(s.colors,3)),t&&(r.setAttribute("skinIndex",new Qt(s.weightsIndices,4)),r.setAttribute("skinWeight",new he(s.vertexWeights,4)),r.FBX_Deformer=t),s.normal.length>0){const u=new Jt().getNormalMatrix(o),l=new he(s.normal,3);l.applyNormalMatrix(u),r.setAttribute("normal",l)}if(s.uvs.forEach(function(u,l){const p=l===0?"uv":`uv${l}`;r.setAttribute(p,new he(s.uvs[l],2))}),a.material&&a.material.mappingType!=="AllSame"){let u=s.materialIndex[0],l=0;if(s.materialIndex.forEach(function(p,f){p!==u&&(r.addGroup(l,f-l,u),u=p,l=f)}),r.groups.length>0){const p=r.groups[r.groups.length-1],f=p.start+p.count;f!==s.materialIndex.length&&r.addGroup(f,s.materialIndex.length-f,u)}r.groups.length===0&&r.addGroup(0,s.materialIndex.length,s.materialIndex[0])}return this.addMorphTargets(r,e,n,o),r}parseGeoNode(e,t){const n={};if(n.vertexPositions=e.Vertices!==void 0?e.Vertices.a:[],n.vertexIndices=e.PolygonVertexIndex!==void 0?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(n.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(n.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(n.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){n.uv=[];let o=0;for(;e.LayerElementUV[o];)e.LayerElementUV[o].UV&&n.uv.push(this.parseUVs(e.LayerElementUV[o])),o++}return n.weightTable={},t!==null&&(n.skeleton=t,t.rawBones.forEach(function(o,r){o.indices.forEach(function(a,s){n.weightTable[a]===void 0&&(n.weightTable[a]=[]),n.weightTable[a].push({id:r,weight:o.weights[s]})})})),n}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let n=0,o=0,r=!1,a=[],s=[],i=[],u=[],l=[],p=[];const f=this;return e.vertexIndices.forEach(function(h,m){let x,v=!1;h<0&&(h=h^-1,v=!0);let C=[],T=[];if(a.push(h*3,h*3+1,h*3+2),e.color){const y=Ge(m,n,h,e.color);i.push(y[0],y[1],y[2])}if(e.skeleton){if(e.weightTable[h]!==void 0&&e.weightTable[h].forEach(function(y){T.push(y.weight),C.push(y.id)}),T.length>4){r||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),r=!0);const y=[0,0,0,0],A=[0,0,0,0];T.forEach(function(V,R){let E=V,w=C[R];A.forEach(function(I,F,_){if(E>I){_[F]=E,E=I;const W=y[F];y[F]=w,w=W}})}),C=y,T=A}for(;T.length<4;)T.push(0),C.push(0);for(let y=0;y<4;++y)l.push(T[y]),p.push(C[y])}if(e.normal){const y=Ge(m,n,h,e.normal);s.push(y[0],y[1],y[2])}e.material&&e.material.mappingType!=="AllSame"&&(x=Ge(m,n,h,e.material)[0],x<0&&(f.negativeMaterialIndices=!0,x=0)),e.uv&&e.uv.forEach(function(y,A){const V=Ge(m,n,h,y);u[A]===void 0&&(u[A]=[]),u[A].push(V[0]),u[A].push(V[1])}),o++,v&&(f.genFace(t,e,a,x,s,i,u,l,p,o),n++,o=0,a=[],s=[],i=[],u=[],l=[],p=[])}),t}getNormalNewell(e){const t=new j(0,0,0);for(let n=0;n<e.length;n++){const o=e[n],r=e[(n+1)%e.length];t.x+=(o.y-r.y)*(o.z+r.z),t.y+=(o.z-r.z)*(o.x+r.x),t.z+=(o.x-r.x)*(o.y+r.y)}return t.normalize(),t}getNormalTangentAndBitangent(e){const t=this.getNormalNewell(e),o=(Math.abs(t.z)>.5?new j(0,1,0):new j(0,0,1)).cross(t).normalize(),r=t.clone().cross(o).normalize();return{normal:t,tangent:o,bitangent:r}}flattenVertex(e,t,n){return new en(e.dot(t),e.dot(n))}genFace(e,t,n,o,r,a,s,i,u,l){let p;if(l>3){const f=[];for(let v=0;v<n.length;v+=3)f.push(new j(t.vertexPositions[n[v]],t.vertexPositions[n[v+1]],t.vertexPositions[n[v+2]]));const{tangent:h,bitangent:m}=this.getNormalTangentAndBitangent(f),x=[];for(const v of f)x.push(this.flattenVertex(v,h,m));p=tn.triangulateShape(x,[])}else p=[[0,1,2]];for(const[f,h,m]of p)e.vertex.push(t.vertexPositions[n[f*3]]),e.vertex.push(t.vertexPositions[n[f*3+1]]),e.vertex.push(t.vertexPositions[n[f*3+2]]),e.vertex.push(t.vertexPositions[n[h*3]]),e.vertex.push(t.vertexPositions[n[h*3+1]]),e.vertex.push(t.vertexPositions[n[h*3+2]]),e.vertex.push(t.vertexPositions[n[m*3]]),e.vertex.push(t.vertexPositions[n[m*3+1]]),e.vertex.push(t.vertexPositions[n[m*3+2]]),t.skeleton&&(e.vertexWeights.push(i[f*4]),e.vertexWeights.push(i[f*4+1]),e.vertexWeights.push(i[f*4+2]),e.vertexWeights.push(i[f*4+3]),e.vertexWeights.push(i[h*4]),e.vertexWeights.push(i[h*4+1]),e.vertexWeights.push(i[h*4+2]),e.vertexWeights.push(i[h*4+3]),e.vertexWeights.push(i[m*4]),e.vertexWeights.push(i[m*4+1]),e.vertexWeights.push(i[m*4+2]),e.vertexWeights.push(i[m*4+3]),e.weightsIndices.push(u[f*4]),e.weightsIndices.push(u[f*4+1]),e.weightsIndices.push(u[f*4+2]),e.weightsIndices.push(u[f*4+3]),e.weightsIndices.push(u[h*4]),e.weightsIndices.push(u[h*4+1]),e.weightsIndices.push(u[h*4+2]),e.weightsIndices.push(u[h*4+3]),e.weightsIndices.push(u[m*4]),e.weightsIndices.push(u[m*4+1]),e.weightsIndices.push(u[m*4+2]),e.weightsIndices.push(u[m*4+3])),t.color&&(e.colors.push(a[f*3]),e.colors.push(a[f*3+1]),e.colors.push(a[f*3+2]),e.colors.push(a[h*3]),e.colors.push(a[h*3+1]),e.colors.push(a[h*3+2]),e.colors.push(a[m*3]),e.colors.push(a[m*3+1]),e.colors.push(a[m*3+2])),t.material&&t.material.mappingType!=="AllSame"&&(e.materialIndex.push(o),e.materialIndex.push(o),e.materialIndex.push(o)),t.normal&&(e.normal.push(r[f*3]),e.normal.push(r[f*3+1]),e.normal.push(r[f*3+2]),e.normal.push(r[h*3]),e.normal.push(r[h*3+1]),e.normal.push(r[h*3+2]),e.normal.push(r[m*3]),e.normal.push(r[m*3+1]),e.normal.push(r[m*3+2])),t.uv&&t.uv.forEach(function(x,v){e.uvs[v]===void 0&&(e.uvs[v]=[]),e.uvs[v].push(s[v][f*2]),e.uvs[v].push(s[v][f*2+1]),e.uvs[v].push(s[v][h*2]),e.uvs[v].push(s[v][h*2+1]),e.uvs[v].push(s[v][m*2]),e.uvs[v].push(s[v][m*2+1])})}addMorphTargets(e,t,n,o){if(n.length===0)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const r=this;n.forEach(function(a){a.rawTargets.forEach(function(s){const i=S.Objects.Geometry[s.geoID];i!==void 0&&r.genMorphGeometry(e,t,i,o,s.name)})})}genMorphGeometry(e,t,n,o,r){const a=t.PolygonVertexIndex!==void 0?t.PolygonVertexIndex.a:[],s=n.Vertices!==void 0?n.Vertices.a:[],i=n.Indexes!==void 0?n.Indexes.a:[],u=e.attributes.position.count*3,l=new Float32Array(u);for(let m=0;m<i.length;m++){const x=i[m]*3;l[x]=s[m*3],l[x+1]=s[m*3+1],l[x+2]=s[m*3+2]}const p={vertexIndices:a,vertexPositions:l},f=this.genBuffers(p),h=new he(f.vertex,3);h.name=r||n.attrName,h.applyMatrix4(o),e.morphAttributes.position.push(h)}parseNormals(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,o=e.Normals.a;let r=[];return n==="IndexToDirect"&&("NormalIndex"in e?r=e.NormalIndex.a:"NormalsIndex"in e&&(r=e.NormalsIndex.a)),{dataSize:3,buffer:o,indices:r,mappingType:t,referenceType:n}}parseUVs(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,o=e.UV.a;let r=[];return n==="IndexToDirect"&&(r=e.UVIndex.a),{dataSize:2,buffer:o,indices:r,mappingType:t,referenceType:n}}parseVertexColors(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,o=e.Colors.a;let r=[];n==="IndexToDirect"&&(r=e.ColorIndex.a);for(let a=0,s=new $;a<o.length;a+=4)s.fromArray(o,a).convertSRGBToLinear().toArray(o,a);return{dataSize:4,buffer:o,indices:r,mappingType:t,referenceType:n}}parseMaterialIndices(e){const t=e.MappingInformationType,n=e.ReferenceInformationType;if(t==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:n};const o=e.Materials.a,r=[];for(let a=0;a<o.length;++a)r.push(a);return{dataSize:1,buffer:o,indices:r,mappingType:t,referenceType:n}}parseNurbsGeometry(e){const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new Ke;const n=t-1,o=e.KnotVector.a,r=[],a=e.Points.a;for(let p=0,f=a.length;p<f;p+=4)r.push(new Ue().fromArray(a,p));let s,i;if(e.Form==="Closed")r.push(r[0]);else if(e.Form==="Periodic"){s=n,i=o.length-1-s;for(let p=0;p<n;++p)r.push(r[p])}const l=new Un(n,o,r,s,i).getPoints(r.length*12);return new Ke().setFromPoints(l)}}class _n{parse(){const e=[],t=this.parseClips();if(t!==void 0)for(const n in t){const o=t[n],r=this.addClip(o);e.push(r)}return e}parseClips(){if(S.Objects.AnimationCurve===void 0)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=S.Objects.AnimationCurveNode,t=new Map;for(const n in e){const o=e[n];if(o.attrName.match(/S|R|T|DeformPercent/)!==null){const r={id:o.id,attr:o.attrName,curves:{}};t.set(r.id,r)}}return t}parseAnimationCurves(e){const t=S.Objects.AnimationCurve;for(const n in t){const o={id:t[n].id,times:t[n].KeyTime.a.map(qn),values:t[n].KeyValueFloat.a},r=O.get(o.id);if(r!==void 0){const a=r.parents[0].ID,s=r.parents[0].relationship;s.match(/X/)?e.get(a).curves.x=o:s.match(/Y/)?e.get(a).curves.y=o:s.match(/Z/)?e.get(a).curves.z=o:s.match(/DeformPercent/)&&e.has(a)&&(e.get(a).curves.morph=o)}}}parseAnimationLayers(e){const t=S.Objects.AnimationLayer,n=new Map;for(const o in t){const r=[],a=O.get(parseInt(o));a!==void 0&&(a.children.forEach(function(i,u){if(e.has(i.ID)){const l=e.get(i.ID);if(l.curves.x!==void 0||l.curves.y!==void 0||l.curves.z!==void 0){if(r[u]===void 0){const p=O.get(i.ID).parents.filter(function(f){return f.relationship!==void 0})[0].ID;if(p!==void 0){const f=S.Objects.Model[p.toString()];if(f===void 0){console.warn("THREE.FBXLoader: Encountered a unused curve.",i);return}const h={modelName:f.attrName?Ve.sanitizeNodeName(f.attrName):"",ID:f.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};z.traverse(function(m){m.ID===f.id&&(h.transform=m.matrix,m.userData.transformData&&(h.eulerOrder=m.userData.transformData.eulerOrder))}),h.transform||(h.transform=new B),"PreRotation"in f&&(h.preRotation=f.PreRotation.value),"PostRotation"in f&&(h.postRotation=f.PostRotation.value),r[u]=h}}r[u]&&(r[u][l.attr]=l)}else if(l.curves.morph!==void 0){if(r[u]===void 0){const p=O.get(i.ID).parents.filter(function(C){return C.relationship!==void 0})[0].ID,f=O.get(p).parents[0].ID,h=O.get(f).parents[0].ID,m=O.get(h).parents[0].ID,x=S.Objects.Model[m],v={modelName:x.attrName?Ve.sanitizeNodeName(x.attrName):"",morphName:S.Objects.Deformer[p].attrName};r[u]=v}r[u][l.attr]=l}}}),n.set(parseInt(o),r))}return n}parseAnimStacks(e){const t=S.Objects.AnimationStack,n={};for(const o in t){const r=O.get(parseInt(o)).children;r.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const a=e.get(r[0].ID);n[o]={name:t[o].attrName,layer:a}}return n}addClip(e){let t=[];const n=this;return e.layer.forEach(function(o){t=t.concat(n.generateTracks(o))}),new nn(e.name,-1,t)}generateTracks(e){const t=[];let n=new j,o=new j;if(e.transform&&e.transform.decompose(n,new ae,o),n=n.toArray(),o=o.toArray(),e.T!==void 0&&Object.keys(e.T.curves).length>0){const r=this.generateVectorTrack(e.modelName,e.T.curves,n,"position");r!==void 0&&t.push(r)}if(e.R!==void 0&&Object.keys(e.R.curves).length>0){const r=this.generateRotationTrack(e.modelName,e.R.curves,e.preRotation,e.postRotation,e.eulerOrder);r!==void 0&&t.push(r)}if(e.S!==void 0&&Object.keys(e.S.curves).length>0){const r=this.generateVectorTrack(e.modelName,e.S.curves,o,"scale");r!==void 0&&t.push(r)}if(e.DeformPercent!==void 0){const r=this.generateMorphTrack(e);r!==void 0&&t.push(r)}return t}generateVectorTrack(e,t,n,o){const r=this.getTimesForAllAxes(t),a=this.getKeyframeTrackValues(r,t,n);return new rn(e+"."+o,r,a)}generateRotationTrack(e,t,n,o,r){let a,s;if(t.x!==void 0&&t.y!==void 0&&t.z!==void 0){const p=this.interpolateRotations(t.x,t.y,t.z,r);a=p[0],s=p[1]}n!==void 0&&(n=n.map(X.degToRad),n.push(r),n=new Q().fromArray(n),n=new ae().setFromEuler(n)),o!==void 0&&(o=o.map(X.degToRad),o.push(r),o=new Q().fromArray(o),o=new ae().setFromEuler(o).invert());const i=new ae,u=new Q,l=[];if(!s||!a)return new ht(e+".quaternion",[],[]);for(let p=0;p<s.length;p+=3)u.set(s[p],s[p+1],s[p+2],r),i.setFromEuler(u),n!==void 0&&i.premultiply(n),o!==void 0&&i.multiply(o),p>2&&new ae().fromArray(l,(p-3)/3*4).dot(i)<0&&i.set(-i.x,-i.y,-i.z,-i.w),i.toArray(l,p/3*4);return new ht(e+".quaternion",a,l)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,n=t.values.map(function(r){return r/100}),o=z.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new on(e.modelName+".morphTargetInfluences["+o+"]",t.times,n)}getTimesForAllAxes(e){let t=[];if(e.x!==void 0&&(t=t.concat(e.x.times)),e.y!==void 0&&(t=t.concat(e.y.times)),e.z!==void 0&&(t=t.concat(e.z.times)),t=t.sort(function(n,o){return n-o}),t.length>1){let n=1,o=t[0];for(let r=1;r<t.length;r++){const a=t[r];a!==o&&(t[n]=a,o=a,n++)}t=t.slice(0,n)}return t}getKeyframeTrackValues(e,t,n){const o=n,r=[];let a=-1,s=-1,i=-1;return e.forEach(function(u){if(t.x&&(a=t.x.times.indexOf(u)),t.y&&(s=t.y.times.indexOf(u)),t.z&&(i=t.z.times.indexOf(u)),a!==-1){const l=t.x.values[a];r.push(l),o[0]=l}else r.push(o[0]);if(s!==-1){const l=t.y.values[s];r.push(l),o[1]=l}else r.push(o[1]);if(i!==-1){const l=t.z.values[i];r.push(l),o[2]=l}else r.push(o[2])}),r}interpolateRotations(e,t,n,o){const r=[],a=[];r.push(e.times[0]),a.push(X.degToRad(e.values[0])),a.push(X.degToRad(t.values[0])),a.push(X.degToRad(n.values[0]));for(let s=1;s<e.values.length;s++){const i=[e.values[s-1],t.values[s-1],n.values[s-1]];if(isNaN(i[0])||isNaN(i[1])||isNaN(i[2]))continue;const u=i.map(X.degToRad),l=[e.values[s],t.values[s],n.values[s]];if(isNaN(l[0])||isNaN(l[1])||isNaN(l[2]))continue;const p=l.map(X.degToRad),f=[l[0]-i[0],l[1]-i[1],l[2]-i[2]],h=[Math.abs(f[0]),Math.abs(f[1]),Math.abs(f[2])];if(h[0]>=180||h[1]>=180||h[2]>=180){const x=Math.max(...h)/180,v=new Q(...u,o),C=new Q(...p,o),T=new ae().setFromEuler(v),y=new ae().setFromEuler(C);T.dot(y)&&y.set(-y.x,-y.y,-y.z,-y.w);const A=e.times[s-1],V=e.times[s]-A,R=new ae,E=new Q;for(let w=0;w<1;w+=1/x)R.copy(T.clone().slerp(y.clone(),w)),r.push(A+w*V),E.setFromQuaternion(R,o),a.push(E.x),a.push(E.y),a.push(E.z)}else r.push(e.times[s]),a.push(X.degToRad(e.values[s])),a.push(X.degToRad(t.values[s])),a.push(X.degToRad(n.values[s]))}return[r,a]}}class Wn{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new Rt,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,n=e.split(/[\r\n]+/);return n.forEach(function(o,r){const a=o.match(/^[\s\t]*;/),s=o.match(/^[\s\t]*$/);if(a||s)return;const i=o.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),u=o.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=o.match("^\\t{"+(t.currentIndent-1)+"}}");i?t.parseNodeBegin(o,i):u?t.parseNodeProperty(o,u,n[++r]):l?t.popStack():o.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(o)}),this.allNodes}parseNodeBegin(e,t){const n=t[1].trim().replace(/^"/,"").replace(/"$/,""),o=t[2].split(",").map(function(i){return i.trim().replace(/^"/,"").replace(/"$/,"")}),r={name:n},a=this.parseNodeAttr(o),s=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(n,r):n in s?(n==="PoseNode"?s.PoseNode.push(r):s[n].id!==void 0&&(s[n]={},s[n][s[n].id]=s[n]),a.id!==""&&(s[n][a.id]=r)):typeof a.id=="number"?(s[n]={},s[n][a.id]=r):n!=="Properties70"&&(n==="PoseNode"?s[n]=[r]:s[n]=r),typeof a.id=="number"&&(r.id=a.id),a.name!==""&&(r.attrName=a.name),a.type!==""&&(r.attrType=a.type),this.pushStack(r)}parseNodeAttr(e){let t=e[0];e[0]!==""&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let n="",o="";return e.length>1&&(n=e[1].replace(/^(\w+)::/,""),o=e[2]),{id:t,name:n,type:o}}parseNodeProperty(e,t,n){let o=t[1].replace(/^"/,"").replace(/"$/,"").trim(),r=t[2].replace(/^"/,"").replace(/"$/,"").trim();o==="Content"&&r===","&&(r=n.replace(/"/g,"").replace(/,$/,"").trim());const a=this.getCurrentNode();if(a.name==="Properties70"){this.parseNodeSpecialProperty(e,o,r);return}if(o==="C"){const i=r.split(",").slice(1),u=parseInt(i[0]),l=parseInt(i[1]);let p=r.split(",").slice(3);p=p.map(function(f){return f.trim().replace(/^"/,"")}),o="connections",r=[u,l],Yn(r,p),a[o]===void 0&&(a[o]=[])}o==="Node"&&(a.id=r),o in a&&Array.isArray(a[o])?a[o].push(r):o!=="a"?a[o]=r:a.a=r,this.setCurrentProp(a,o),o==="a"&&r.slice(-1)!==","&&(a.a=Je(r))}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,e.slice(-1)!==","&&(t.a=Je(t.a))}parseNodeSpecialProperty(e,t,n){const o=n.split('",').map(function(l){return l.trim().replace(/^\"/,"").replace(/\s/,"_")}),r=o[0],a=o[1],s=o[2],i=o[3];let u=o[4];switch(a){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":u=parseFloat(u);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":u=Je(u);break}this.getPrevNode()[r]={type:a,type2:s,flag:i,value:u},this.setCurrentProp(this.getPrevNode(),r)}}class Hn{parse(e){const t=new wt(e);t.skip(23);const n=t.getUint32();if(n<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+n);const o=new Rt;for(;!this.endOfContent(t);){const r=this.parseNode(t,n);r!==null&&o.add(r.name,r)}return o}endOfContent(e){return e.size()%16===0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const n={},o=t>=7500?e.getUint64():e.getUint32(),r=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const a=e.getUint8(),s=e.getString(a);if(o===0)return null;const i=[];for(let f=0;f<r;f++)i.push(this.parseProperty(e));const u=i.length>0?i[0]:"",l=i.length>1?i[1]:"",p=i.length>2?i[2]:"";for(n.singleProperty=r===1&&e.getOffset()===o;o>e.getOffset();){const f=this.parseNode(e,t);f!==null&&this.parseSubNode(s,n,f)}return n.propertyList=i,typeof u=="number"&&(n.id=u),l!==""&&(n.attrName=l),p!==""&&(n.attrType=p),s!==""&&(n.name=s),n}parseSubNode(e,t,n){if(n.singleProperty===!0){const o=n.propertyList[0];Array.isArray(o)?(t[n.name]=n,n.a=o):t[n.name]=o}else if(e==="Connections"&&n.name==="C"){const o=[];n.propertyList.forEach(function(r,a){a!==0&&o.push(r)}),t.connections===void 0&&(t.connections=[]),t.connections.push(o)}else if(n.name==="Properties70")Object.keys(n).forEach(function(r){t[r]=n[r]});else if(e==="Properties70"&&n.name==="P"){let o=n.propertyList[0],r=n.propertyList[1];const a=n.propertyList[2],s=n.propertyList[3];let i;o.indexOf("Lcl ")===0&&(o=o.replace("Lcl ","Lcl_")),r.indexOf("Lcl ")===0&&(r=r.replace("Lcl ","Lcl_")),r==="Color"||r==="ColorRGB"||r==="Vector"||r==="Vector3D"||r.indexOf("Lcl_")===0?i=[n.propertyList[4],n.propertyList[5],n.propertyList[6]]:i=n.propertyList[4],t[o]={type:r,type2:a,flag:s,value:i}}else t[n.name]===void 0?typeof n.id=="number"?(t[n.name]={},t[n.name][n.id]=n):t[n.name]=n:n.name==="PoseNode"?(Array.isArray(t[n.name])||(t[n.name]=[t[n.name]]),t[n.name].push(n)):t[n.name][n.id]===void 0&&(t[n.name][n.id]=n)}parseProperty(e){const t=e.getString(1);let n;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return n=e.getUint32(),e.getArrayBuffer(n);case"S":return n=e.getUint32(),e.getString(n);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const o=e.getUint32(),r=e.getUint32(),a=e.getUint32();if(r===0)switch(t){case"b":case"c":return e.getBooleanArray(o);case"d":return e.getFloat64Array(o);case"f":return e.getFloat32Array(o);case"i":return e.getInt32Array(o);case"l":return e.getInt64Array(o)}const s=In(new Uint8Array(e.getArrayBuffer(a))),i=new wt(s.buffer);switch(t){case"b":case"c":return i.getBooleanArray(o);case"d":return i.getFloat64Array(o);case"f":return i.getFloat32Array(o);case"i":return i.getInt32Array(o);case"l":return i.getInt64Array(o)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class wt{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=t!==void 0?t:!0,this._textDecoder=new TextDecoder}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return(this.getUint8()&1)===1}getBooleanArray(e){const t=[];for(let n=0;n<e;n++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t&2147483648?(t=~t&4294967295,e=~e&4294967295,e===4294967295&&(t=t+1&4294967295),e=e+1&4294967295,-(t*4294967296+e)):t*4294967296+e}getInt64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t*4294967296+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){const t=this.offset;let n=new Uint8Array(this.dv.buffer,t,e);this.skip(e);const o=n.indexOf(0);return o>=0&&(n=new Uint8Array(this.dv.buffer,t,o)),this._textDecoder.decode(n)}}class Rt{add(e,t){this[e]=t}}function Nn(c){const e="Kaydara FBX Binary  \0";return c.byteLength>=e.length&&e===Mt(c,0,e.length)}function $n(c){const e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let t=0;function n(o){const r=c[o-1];return c=c.slice(t+o),t++,r}for(let o=0;o<e.length;++o)if(n(1)===e[o])return!1;return!0}function vt(c){const e=/FBXVersion: (\d+)/,t=c.match(e);if(t)return parseInt(t[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function qn(c){return c/46186158e3}const Kn=[];function Ge(c,e,t,n){let o;switch(n.mappingType){case"ByPolygonVertex":o=c;break;case"ByPolygon":o=e;break;case"ByVertice":o=t;break;case"AllSame":o=n.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+n.mappingType)}n.referenceType==="IndexToDirect"&&(o=n.indices[o]);const r=o*n.dataSize,a=r+n.dataSize;return Zn(Kn,n.buffer,r,a)}const Qe=new Q,me=new j;function Lt(c){const e=new B,t=new B,n=new B,o=new B,r=new B,a=new B,s=new B,i=new B,u=new B,l=new B,p=new B,f=new B,h=c.inheritType?c.inheritType:0;if(c.translation&&e.setPosition(me.fromArray(c.translation)),c.preRotation){const F=c.preRotation.map(X.degToRad);F.push(c.eulerOrder||Q.DEFAULT_ORDER),t.makeRotationFromEuler(Qe.fromArray(F))}if(c.rotation){const F=c.rotation.map(X.degToRad);F.push(c.eulerOrder||Q.DEFAULT_ORDER),n.makeRotationFromEuler(Qe.fromArray(F))}if(c.postRotation){const F=c.postRotation.map(X.degToRad);F.push(c.eulerOrder||Q.DEFAULT_ORDER),o.makeRotationFromEuler(Qe.fromArray(F)),o.invert()}c.scale&&r.scale(me.fromArray(c.scale)),c.scalingOffset&&s.setPosition(me.fromArray(c.scalingOffset)),c.scalingPivot&&a.setPosition(me.fromArray(c.scalingPivot)),c.rotationOffset&&i.setPosition(me.fromArray(c.rotationOffset)),c.rotationPivot&&u.setPosition(me.fromArray(c.rotationPivot)),c.parentMatrixWorld&&(p.copy(c.parentMatrix),l.copy(c.parentMatrixWorld));const m=t.clone().multiply(n).multiply(o),x=new B;x.extractRotation(l);const v=new B;v.copyPosition(l);const C=v.clone().invert().multiply(l),T=x.clone().invert().multiply(C),y=r,A=new B;if(h===0)A.copy(x).multiply(m).multiply(T).multiply(y);else if(h===1)A.copy(x).multiply(T).multiply(m).multiply(y);else{const _=new B().scale(new j().setFromMatrixScale(p)).clone().invert(),W=T.clone().multiply(_);A.copy(x).multiply(m).multiply(W).multiply(y)}const V=u.clone().invert(),R=a.clone().invert();let E=e.clone().multiply(i).multiply(u).multiply(t).multiply(n).multiply(o).multiply(V).multiply(s).multiply(a).multiply(r).multiply(R);const w=new B().copyPosition(E),I=l.clone().multiply(w);return f.copyPosition(I),E=f.clone().multiply(A),E.premultiply(l.invert()),E}function Et(c){c=c||0;const e=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return c===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),e[0]):e[c]}function Je(c){return c.split(",").map(function(t){return parseFloat(t)})}function Mt(c,e,t){return e===void 0&&(e=0),t===void 0&&(t=c.byteLength),new TextDecoder().decode(new Uint8Array(c,e,t))}function Yn(c,e){for(let t=0,n=c.length,o=e.length;t<o;t++,n++)c[n]=e[t]}function Zn(c,e,t,n){for(let o=t,r=0;o<n;o++,r++)c[r]=e[o];return c}async function Qn({mountEl:c}){const e=new an({antialias:!0});e.setPixelRatio(Math.min(devicePixelRatio,2)),e.setSize(c.clientWidth,c.clientHeight),e.shadowMap.enabled=!0,e.shadowMap.type=sn,e.outputColorSpace=Pe,c.innerHTML="",c.appendChild(e.domElement);const t=new cn;t.background=new $(724762),t.fog=new ln(461330,10,36);const n=new bt(55,c.clientWidth/c.clientHeight,.1,250);n.position.set(2.2,1.6,3.2);const o=new wn(n,e.domElement);o.target.set(0,1.1,0),o.enableDamping=!0,o.dampingFactor=.08,t.add(new un(15397631,2764603,.65));const r=new Tt(16777215,1.05);r.position.set(5,8,4),r.castShadow=!0,r.shadow.mapSize.set(1024,1024),r.shadow.camera.near=.5,r.shadow.camera.far=70,r.shadow.camera.left=-16,r.shadow.camera.right=16,r.shadow.camera.top=16,r.shadow.camera.bottom=-16,t.add(r);const a=new ge(16769459,.35,24,2);a.position.set(0,3.2,-1),t.add(a);const s=new ge(3900150,.35,22,2);s.position.set(-6,2.6,1),t.add(s);const i=new ge(11032055,.25,20,2);i.position.set(6,2.4,-2),t.add(i);const u=new J;u.name="NX_CLASSROOM_ENV",t.add(u);const l=new N({color:2828841,roughness:.95,metalness:.02}),p=new N({color:1712694,roughness:.98,metalness:0}),f=new N({color:1514018,roughness:.9}),h=new N({color:2767430,roughness:.65,metalness:.05}),m=new N({color:5594731,metalness:.85,roughness:.3}),x=new N({color:725024,roughness:.55,emissive:new $(461846),emissiveIntensity:.55}),v=new N({color:3900150,roughness:.18,metalness:.2,emissive:new $(1389482),emissiveIntensity:1.35}),C=new N({color:3359061,roughness:.9,metalness:0}),T=new N({color:14069898,roughness:.85,metalness:0}),y=new N({color:1120295,roughness:.8,metalness:0}),A=new G(new ie(18,14),l);A.rotation.x=-Math.PI/2,A.receiveShadow=!0,u.add(A);const V=new G(new ie(18,6),p);V.position.set(0,3,-7.4),u.add(V);const R=new G(new ie(14,6),p);R.rotation.y=Math.PI/2,R.position.set(-9,3,0),u.add(R);const E=new G(new ie(14,6),p);E.rotation.y=-Math.PI/2,E.position.set(9,3,0),u.add(E);const w=new G(new ie(18,14),f);w.rotation.x=Math.PI/2,w.position.y=6,u.add(w);const I=new J;I.position.set(0,5.95,0),u.add(I);const F=new ie(1.7,1.1),_=new N({color:1844019,roughness:.9,metalness:0});for(let g=-4;g<=4;g+=2)for(let d=-3;d<=3;d+=2){const b=new G(F,_);b.rotation.x=Math.PI/2,b.position.set(g,0,d),I.add(b)}const W=new G(new we(7,2.6,.12),m);W.position.set(0,3.1,-7.25),W.castShadow=!0,u.add(W);const K=new G(new ie(6.6,2.2),x);K.position.set(0,3.1,-7.19),u.add(K);const H=new J;H.name="NX_SCREEN";const pe=new G(new we(2.8,1.65,.1),m);pe.position.set(3.6,2.55,-7.22),pe.castShadow=!0,H.add(pe);const U=new G(new ie(2.5,1.38),v);U.position.set(3.6,2.55,-7.17),H.add(U);const Ie=new ge(3900150,.45,12,2);Ie.position.set(3.6,2.55,-6.6),H.add(Ie),u.add(H);const Re=new J;u.add(Re);const ee=[],te=2.6,Le=-te,le=-.8,ve=2.2,ue=[];for(let g=0;g<2;g++)for(let d=0;d<3;d++){const b=Le+d*te,P=le+g*ve,L=yt({w:2.1,h:.78,d:1.05},h,m);L.position.set(b,0,P),Re.add(L);const D=Jn(h,m);D.position.set(b,0,P+.95),D.rotation.y=0,D.name=`NX_CHAIR_${g}_${d}`,u.add(D),ue.push(D),ee.push({x:D.position.x,z:D.position.z,rotY:D.rotation.y})}const fe=new J;fe.name="NX_STUDENTS",u.add(fe);for(let g=0;g<ee.length;g++){if(g%2===1)continue;const d=er(C,T,y);d.position.set(ee[g].x,0,ee[g].z),d.rotation.y=ee[g].rotY,fe.add(d)}const ne=yt({w:2.8,h:.85,d:1.25},h,m);ne.position.set(-1.9,0,-6.25),ne.name="NX_FRONT_DESK",u.add(ne);const xe=new zn,k=await xt(xe,"/avatar/Xbot.fbx");k.traverse(g=>{g.isMesh&&(g.castShadow=!0,g.frustumCulled=!1)}),k.scale.setScalar(.01),k.position.set(.2,0,-4.85),k.rotation.y=0,t.add(k);const ot=new pn(k),Ee={};let Me=null;async function ye(g,d){var D;const P=(D=(await xt(xe,d)).animations)==null?void 0:D[0];if(!P)throw new Error(`Missing animation in ${d}`);const L=ot.clipAction(P);L.enabled=!0,L.setEffectiveTimeScale(1),L.setEffectiveWeight(1),Ee[g]=L}await Promise.all([ye("idle","/avatar/idle.fbx"),ye("walk","/avatar/walk.fbx"),ye("wave","/avatar/wave.fbx"),ye("point","/avatar/point.fbx"),ye("posture","/avatar/posture.fbx")]);function at(g,d=.18){if(g){for(const b of Object.values(Ee))!b||b===g||b.isRunning()&&b.fadeOut(.12);g.reset(),g.enabled=!0,g.setEffectiveWeight(1),g.setEffectiveTimeScale(1),g.fadeIn(.12).play(),Me&&Me!==g&&Me.crossFadeTo(g,d,!1),Me=g}}function re(g){const d=Ee[g];d&&(d.setLoop(hn,1/0),d.clampWhenFinished=!1,at(d))}function de(g){const d=Ee[g];return d?(d.setLoop(gn,1),d.clampWhenFinished=!0,at(d),d.getClip().duration||1):0}re("idle");const be=new fn,Te=new j,ze=new j;function oe(g){return be.setFromObject(g),be.getCenter(Te),Te.clone()}function De(g,d=.75){be.setFromObject(g),be.getCenter(Te),be.getSize(ze);const P=(Math.max(ze.x,ze.z)||1)*.5+d,L=k.position.clone(),Z=Te.clone().sub(L);return Z.y=0,Z.lengthSq()<1e-6&&Z.set(0,0,-1),Z.normalize(),Te.clone().addScaledVector(Z,-P)}function Se(g){const d=g.clone().sub(k.position);return d.y=0,d.lengthSq()<1e-6?k.rotation.y:Math.atan2(d.x,d.z)}function Xe(g){for(;g>Math.PI;)g-=Math.PI*2;for(;g<-Math.PI;)g+=Math.PI*2;return g}function it(g,d,b){const P=Xe(g),L=Xe(d-P);return P+L*b}let ke=null,Be=null,je=null;function Ce(g,d,b){ke=g.clone(),Be=d?d.clone():null,je=typeof b=="function"?b:null,re("walk")}function st(g){return new Promise(d=>setTimeout(d,g))}const ct=k.position.clone(),Oe=k.rotation.y,Dt=v.emissiveIntensity;let _e=Math.random()*1e3;async function Bt(g){de("point"),g==null||g("Pointing."),await st(650),de("posture"),g==null||g("Safety posture."),await st(900),re("idle")}function Ot(g){g==null||g("Walking back..."),Ce(ct,new j(0,k.position.y,10),()=>{k.position.copy(ct),k.rotation.y=Oe,re("idle"),g==null||g("Back at the front.")})}async function Gt(g,d){const b=String(g||"").toLowerCase().trim();if(b){if(b==="reset"||b.includes("walk back")||b.includes("go back")||b==="back"){Ot(d);return}if((b.includes("walk")||b.includes("go"))&&b.includes("chair")){let P=null,L=1/0;for(const We of ue){const ut=oe(We).distanceTo(k.position);ut<L&&(L=ut,P=We)}if(!P){d==null||d("No chair found.");return}const D=oe(P),Z=De(P,.55);d==null||d("Walking to the chair..."),Ce(Z,D,()=>{re("idle"),k.rotation.y=Math.PI,d==null||d("At the chair.")});return}if((b.includes("walk")||b.includes("go"))&&(b.includes("desk")||b.includes("front desk"))){const P=oe(ne),L=De(ne,.65);d==null||d("Walking to the desk..."),Ce(L,P,()=>{re("idle"),k.rotation.y=Oe,d==null||d("At the desk.")});return}if((b.includes("walk")||b.includes("go"))&&b.includes("screen")){const P=oe(U),L=De(U,1);d==null||d("Walking to the screen..."),Ce(L,P,()=>{re("idle"),d==null||d("Arrived at the screen.")});return}if(b.includes("point")&&b.includes("screen")){const P=oe(U),L=De(U,1);d==null||d("Walking to the screen..."),Ce(L,P,async()=>{k.rotation.y=Se(P),await Bt(d),d==null||d("Turning back to the class...");const D=Oe;k.userData.__turnTarget=D});return}if(b.includes("point")&&b.includes("desk")){const P=oe(ne);k.rotation.y=Se(P),de("point"),d==null||d("Pointing at the desk.");return}if(b.includes("point")&&b.includes("chair")){let P=null,L=1/0;for(const Z of ue){const He=oe(Z).distanceTo(k.position);He<L&&(L=He,P=Z)}if(!P){d==null||d("No chair found.");return}const D=oe(P);k.rotation.y=Se(D),de("point"),d==null||d("Pointing at the chair.");return}if(b.includes("wave")){k.rotation.y=Oe,de("wave"),d==null||d("Waving.");return}if(b.includes("pose")||b.includes("posture")){de("posture"),d==null||d("Safety posture.");return}re("idle"),d==null||d("Ready.")}}new ResizeObserver(()=>{const g=Math.max(1,c.clientWidth),d=Math.max(1,c.clientHeight);e.setSize(g,d,!1),n.aspect=g/d,n.updateProjectionMatrix()}).observe(c);const Vt=new mn;function lt(){const g=Vt.getDelta();if(ot.update(g),o.update(),typeof k.userData.__turnTarget=="number"){const P=k.userData.__turnTarget;k.rotation.y=it(k.rotation.y,P,Math.min(1,6.5*g)),Math.abs(Xe(P-k.rotation.y))<.01&&delete k.userData.__turnTarget}if(ke){const P=Se(Be||ke);k.rotation.y=it(k.rotation.y,P,Math.min(1,10*g));const L=ke.clone().sub(k.position);if(L.y=0,L.length()<.06){ke=null,Be=null,re("idle");const D=je;je=null,D==null||D()}else L.normalize(),k.position.addScaledVector(L,.98*g)}_e+=g;const d=.08*Math.sin(_e*2.3),b=.03*Math.sin(_e*17+1.7);v.emissiveIntensity=Dt*(1+d+b),e.render(t,n),requestAnimationFrame(lt)}return lt(),{runCommand:Gt,scene:t,renderer:e}}function xt(c,e){return new Promise((t,n)=>c.load(e,t,void 0,n))}function yt(c,e,t){const n=new J,o=new G(new we(c.w,.1,c.d),e);o.position.set(0,c.h,0),o.castShadow=!0,o.receiveShadow=!0,n.add(o);const r=new rt(.06,.06,c.h,14),a=[[-c.w/2+.18,c.h/2,-c.d/2+.18],[c.w/2-.18,c.h/2,-c.d/2+.18],[-c.w/2+.18,c.h/2,c.d/2-.18],[c.w/2-.18,c.h/2,c.d/2-.18]];for(const[s,i,u]of a){const l=new G(r,t);l.position.set(s,i,u),l.castShadow=!0,n.add(l)}return n}function Jn(c,e){const t=new J,n=new G(new we(.85,.08,.85),c);n.position.set(0,.48,0),n.castShadow=!0,n.receiveShadow=!0,t.add(n);const o=new G(new we(.85,.75,.08),c);o.position.set(0,.86,.38),o.castShadow=!0,t.add(o);const r=new rt(.05,.05,.48,12),a=[[-.34,.24,-.34],[.34,.24,-.34],[-.34,.24,.34],[.34,.24,.34]];for(const[s,i,u]of a){const l=new G(r,e);l.position.set(s,i,u),l.castShadow=!0,t.add(l)}return t}function er(c,e,t){const n=new J,o=new G(new dn(.16,.38,6,10),c);o.position.set(0,.85,.06),o.castShadow=!0,n.add(o);const r=new G(new mt(.14,16,16),e);r.position.set(0,1.22,.08),r.castShadow=!0,n.add(r);const a=new G(new mt(.145,16,16),t);a.scale.set(1,.72,1),a.position.set(0,1.27,.07),a.castShadow=!0,n.add(a);const s=new rt(.06,.06,.35,10),i=new G(s,c);i.position.set(-.08,.56,-.08),i.rotation.x=Math.PI/2.7,i.castShadow=!0;const u=i.clone();u.position.x=.08,n.add(i,u);const l=new we(.12,.06,.18),p=new N({color:988970,roughness:.9}),f=new G(l,p);f.position.set(-.08,.38,.12),f.castShadow=!0;const h=f.clone();return h.position.x=.08,n.add(f,h),n}(function(){function c(r,a,s=""){document.body.innerHTML=`<pre style="white-space:pre-wrap;padding:16px;color:#fff;background:#0b0f1a">${r}:
${a}

${s}
</pre>`}window.addEventListener("error",r=>{var s;const a=((s=r==null?void 0:r.error)==null?void 0:s.message)||r.message||"Unknown error";c("JS Error",a,`${r.filename||""}:${r.lineno||""}:${r.colno||""}`.trim())}),window.addEventListener("unhandledrejection",r=>{var s;const a=((s=r==null?void 0:r.reason)==null?void 0:s.message)||String(r.reason||"Unhandled rejection");c("Promise Error",a)});function e(r,a={},s=[]){const i=document.createElement(r);for(const[u,l]of Object.entries(a))u==="style"?i.style.cssText=l:u==="class"?i.className=l:u.startsWith("on")&&typeof l=="function"?i.addEventListener(u.slice(2).toLowerCase(),l):i.setAttribute(u,l);for(const u of s)i.appendChild(typeof u=="string"?document.createTextNode(u):u);return i}function t(){return new Promise((r,a)=>{const s=()=>document.querySelector("#app"),i=s();if(i)return r(i);const u=()=>{const l=s();if(!l){document.body.innerHTML="<pre style='color:#fff;padding:16px;background:#0b0f1a'>Missing #app mount element</pre>",a(new Error("Missing #app"));return}r(l)};document.readyState==="loading"?window.addEventListener("DOMContentLoaded",u,{once:!0}):u()})}function n(){let r=document.querySelector("#nxAvatarPanel");if(r)return r;const a=e("style",{},[`
      :root{
        --bg:#0b0f1a;
        --panel:rgba(12,16,28,0.82);
        --panel2:rgba(255,255,255,0.06);
        --border:rgba(255,255,255,0.12);
        --border2:rgba(255,255,255,0.18);
        --text:rgba(255,255,255,0.96);
        --muted:rgba(255,255,255,0.74);
        --muted2:rgba(255,255,255,0.60);
        --shadow:0 22px 60px rgba(0,0,0,0.60);
        --radius:16px;

        /* prototype 2 accent */
        --accent:#a855f7;
        --accent2:rgba(168,85,247,0.18);
        --accentBorder:rgba(168,85,247,0.62);
      }

      #nxAvatarPanel{
        position:fixed;
        top:18px; left:18px;
        width:min(620px, calc(100vw - 36px));
        background:var(--panel);
        border:1px solid rgba(255,255,255,0.10);
        border-radius:var(--radius);
        box-shadow:var(--shadow);
        padding:16px;
        z-index: 50;
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        color:var(--text);
        pointer-events:auto;
        user-select:none;
      }

      #nxHeaderRow{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
      }

      #nxTitle{
        display:flex;
        align-items:center;
        gap:10px;
        font-weight:900;
        font-size:14px;
        letter-spacing:0.2px;
      }
      .nxTitleSub{ font-weight:750; opacity:0.92; }

      #nxBadge{
        font-size:11px;
        padding:4px 9px;
        border-radius:999px;
        background:var(--accent2);
        border:1px solid rgba(168,85,247,0.38);
        color:rgba(245,236,255,0.98);
        user-select:none;
        white-space:nowrap;
      }

      #nxHeaderActions{ display:flex; gap:8px; align-items:center; }

      /* Buttons (same feel as Prototype 1) */
      #nxAvatarPanel button{
        padding:10px 12px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,0.16);
        background:rgba(255,255,255,0.10);
        color:rgba(255,255,255,0.95);
        font-weight:850;
        cursor:pointer;
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease, opacity 120ms ease;
        user-select:none;
        white-space:nowrap;
      }
      #nxAvatarPanel button:hover{
        transform: translateY(-1px);
        background: rgba(255,255,255,0.14);
        border-color: rgba(255,255,255,0.24);
      }
      #nxAvatarPanel button:active{ transform: translateY(0px); }
      #nxAvatarPanel button:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

      #nxAvatarPanel button.primary{
        background:rgba(168,85,247,0.92);
        border-color:rgba(168,85,247,0.62);
        color:#fff;
      }
      #nxAvatarPanel button.primary:hover{
        background:rgba(168,85,247,0.84);
        border-color:rgba(168,85,247,0.78);
      }

      #nxHint{
        margin-top:12px;
        padding:10px 12px;
        border-radius:14px;
        border:1px solid rgba(255,255,255,0.10);
        background:rgba(255,255,255,0.06);
        font-size:12.5px;
        line-height:1.5;
        color:var(--muted);
        user-select:text;
      }
      #nxHint b{ color:#fff; }

      /*  Input row = Prototype 1: input + primary button (+ reset) */
      #nxRow{
        display:flex;
        gap:10px;
        margin-top:14px;
        align-items:center;
      }

      #nxCmd{
        flex:1;
        width:100%;
        padding:12px 12px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,0.16);
        background:rgba(255,255,255,0.07);
        color:#fff;
        outline:none;
        font-size:13.5px;
        user-select:text;
        pointer-events:auto;
      }
      #nxCmd::placeholder{ color: rgba(255,255,255,0.55); }
      #nxCmd:focus{
        border-color: rgba(168,85,247,0.75);
        box-shadow: 0 0 0 4px rgba(168,85,247,0.18);
      }

      #nxChips{
        display:flex;
        gap:8px;
        flex-wrap:wrap;
        margin-top:12px;
      }
      .nxChip{
        appearance:none;
        border:1px solid rgba(255,255,255,0.14);
        background:rgba(255,255,255,0.08);
        color:rgba(255,255,255,0.92);
        border-radius:999px;
        padding:8px 11px;
        font-size:11.5px;
        cursor:pointer;
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease, opacity 120ms ease;
        user-select:none;
        white-space:nowrap;
      }
      .nxChip:hover{
        transform: translateY(-1px);
        background: rgba(255,255,255,0.12);
        border-color: rgba(255,255,255,0.22);
      }
      .nxChip:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

      #nxStatusRow{
        margin-top:12px;
        font-size:12.5px;
        color:var(--muted);
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
      }
      #nxStatusLeft{
        display:flex;
        align-items:center;
        gap:8px;
        min-width: 0;
      }
      #nxStatusDot{
        width:10px; height:10px;
        border-radius:999px;
        background:rgba(168,85,247,0.95);
        box-shadow: 0 0 0 4px rgba(168,85,247,0.14);
        flex:0 0 auto;
      }
      #nxStatusDot.busy{ box-shadow: 0 0 0 4px rgba(168,85,247,0.18); }
      #nxStatusDot.err{
        background:rgba(239,68,68,0.95);
        box-shadow: 0 0 0 4px rgba(239,68,68,0.16);
      }
      #nxStatusText{
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
      }

      #nxGrid{
        margin-top:12px;
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:10px;
      }
      .nxCard{
        border:1px solid rgba(255,255,255,0.10);
        background:rgba(255,255,255,0.05);
        border-radius:14px;
        padding:10px 12px;
        min-height: 92px;
        overflow:hidden;
        user-select:text;
      }
      .nxCardTitle{
        font-size:11px;
        color:var(--muted2);
        text-transform:uppercase;
        letter-spacing:.12em;
        margin-bottom:8px;
        user-select:none;
      }
      .nxCardBody{
        font-size:13px;
        color:rgba(255,255,255,0.90);
        line-height:1.35;
        white-space:pre-wrap;
        overflow-wrap:anywhere;
      }
      #nxLog{
        font-family: ui-monospace, Menlo, Consolas, monospace;
        font-size:11.5px;
        color:rgba(255,255,255,0.82);
        white-space:pre-wrap;
        max-height:150px;
        overflow:auto;
      }

      @media (max-width: 520px){
        #nxAvatarPanel{
          top:auto;
          bottom:18px;
          left:18px;
          right:18px;
          width:auto;
        }
        #nxRow{ flex-direction:column; align-items:stretch; }
        #nxGrid{ grid-template-columns: 1fr; }
      }
      `]);r=e("div",{id:"nxAvatarPanel"});const s=e("div",{id:"nxHeaderRow"},[e("div",{id:"nxTitle"},[e("span",{},["NexEra"]),e("span",{class:"nxTitleSub"},["NL  Avatar"]),e("span",{id:"nxBadge",title:"Prototype demo"},["Prototype 2"])]),e("div",{id:"nxHeaderActions"},[e("button",{id:"nxBack",type:"button",class:"secondary",title:"Back to Prototype 1",onclick:()=>location.href="/?mode=asset"},["Prototype 1"]),e("button",{id:"nxHelp",type:"button",class:"secondary"},["Help"])])]),i=e("div",{id:"nxHint"},["Try: ",e("b",{},['"Point at the screen"']),"  ",e("b",{},['"Walk to the desk"']),"  ",e("b",{},['"Wave hello"']),"  ",e("b",{},['"Walk back"']),"."]),u=e("input",{id:"nxCmd",placeholder:"Type a command, then press Enter...",autocomplete:"off",spellcheck:"false"}),l=e("button",{id:"nxRun",class:"primary",type:"button"},["Run"]),p=e("button",{id:"nxReset",type:"button"},["Reset"]),f=e("div",{id:"nxRow"},[u,l,p]),h=e("div",{id:"nxChips"},[e("button",{class:"nxChip",type:"button","data-t":"Walk to the desk"},["Walk  desk"]),e("button",{class:"nxChip",type:"button","data-t":"Walk to the screen"},["Walk  screen"]),e("button",{class:"nxChip",type:"button","data-t":"Point at the screen"},["Point  screen"]),e("button",{class:"nxChip",type:"button","data-t":"Wave hello"},["Wave"]),e("button",{class:"nxChip",type:"button","data-t":"Walk back"},["Walk back"])]),m=e("span",{id:"nxStatusDot",title:"Ready"}),x=e("span",{id:"nxStatusText"},["Ready."]),v=e("div",{id:"nxStatusRow"},[e("div",{id:"nxStatusLeft"},[m,x])]),C=e("div",{class:"nxCardBody",id:"nxExplain"},["Ready."]),T=e("div",{id:"nxLog"},[""]),y=e("div",{id:"nxGrid"},[e("div",{class:"nxCard"},[e("div",{class:"nxCardTitle"},["Explanation"]),C]),e("div",{class:"nxCard"},[e("div",{class:"nxCardTitle"},["Run log"]),T])]);return r.appendChild(a),r.appendChild(s),r.appendChild(i),r.appendChild(f),r.appendChild(h),r.appendChild(v),r.appendChild(y),document.body.appendChild(r),r}async function o(){const r=await t();n();const a=document.querySelector("#nxStatusDot"),s=document.querySelector("#nxStatusText"),i=document.querySelector("#nxExplain"),u=document.querySelector("#nxLog"),l=document.querySelector("#nxCmd"),p=document.querySelector("#nxRun"),f=document.querySelector("#nxReset"),h=document.querySelector("#nxHelp");function m(w,I){s&&(s.textContent=I||""),a&&(a.classList.remove("busy","err"),w==="busy"&&a.classList.add("busy"),w==="err"&&a.classList.add("err"))}function x(w,I){const F=new Date,_=String(F.getHours()).padStart(2,"0"),W=String(F.getMinutes()).padStart(2,"0"),K=String(F.getSeconds()).padStart(2,"0"),H=`[${_}:${W}:${K}] ${w}: ${I}
`;u&&(u.textContent=(H+u.textContent).slice(0,6e3))}m("busy","Initializing...");let v;try{v=await Qn({mountEl:r})}catch(w){throw m("err","Init failed"),i&&(i.textContent=`Error: ${(w==null?void 0:w.message)||String(w)}`),w}if(!v||typeof v.runCommand!="function"){m("err","API mismatch");const w=v?Object.keys(v).join(", "):"(none)";throw i&&(i.textContent=`Error: Expected api.runCommand(). Got: ${w}`),new Error("Avatar API mismatch (missing runCommand)")}const C=[];let T=-1,y=!1;function A(w){p&&(p.disabled=!w),f&&(f.disabled=!w),document.querySelectorAll("#nxChips .nxChip").forEach(I=>I.disabled=!w),l&&(l.disabled=!w)}async function V(w){const I=String(w||"").trim();I&&await v.runCommand(I,F=>{const _=typeof F=="string"?F:String(F||"");i&&(i.textContent=_)})}async function R(){if(!y){y=!0,A(!1);try{m("busy","Resetting..."),x("RUN","Walk back"),l&&(l.value=""),i&&(i.textContent="Resetting..."),await V("Walk back"),m("ok","Ready"),i&&(i.textContent=" Reset complete. Ready."),l==null||l.focus()}catch(w){const I=(w==null?void 0:w.message)||String(w);m("err","Error"),i&&(i.textContent=`Error: ${I}`),x("ERROR",I),console.error(w)}finally{y=!1,A(!0)}}}async function E(w){const I=(w??(l==null?void 0:l.value)??"").trim();if(!(!I||y)){y=!0,A(!1),C.push(I),T=C.length,m("busy","Running..."),x("RUN",I);try{if(I.toLowerCase()==="reset"){await R();return}await V(I),m("ok","Ready"),l&&(l.value=""),l==null||l.focus()}catch(F){const _=(F==null?void 0:F.message)||String(F);m("err","Error"),i&&(i.textContent=`Error: ${_}`),x("ERROR",_),console.error(F)}finally{y=!1,A(!0)}}}p==null||p.addEventListener("click",()=>E()),f==null||f.addEventListener("click",()=>R()),h==null||h.addEventListener("click",()=>{i&&(i.textContent='Try: "Point at the screen"  "Walk to the desk"  "Wave hello"  "Walk back".')}),l==null||l.addEventListener("keydown",w=>{if(w.key==="Enter"){w.preventDefault(),E();return}if(w.key==="Escape"){w.preventDefault(),l.value="";return}if(w.key==="ArrowUp"){if(w.preventDefault(),!C.length)return;T=Math.max(0,T-1),l.value=C[T]??l.value,l.setSelectionRange(l.value.length,l.value.length);return}if(w.key==="ArrowDown"){if(w.preventDefault(),!C.length)return;T=Math.min(C.length,T+1),l.value=C[T]??"",l.setSelectionRange(l.value.length,l.value.length);return}}),document.querySelectorAll("#nxChips .nxChip").forEach(w=>{w.addEventListener("click",()=>E(w.getAttribute("data-t")))}),A(!0),setTimeout(()=>l==null?void 0:l.focus(),50),m("ok","Ready"),i&&(i.textContent="Ready.")}o().catch(r=>{const a=r&&r.message?r.message:String(r);c("AVATAR BOOT ERROR",a),console.error(r)})})();
